<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime chat</title>
    <link rel="stylesheet" href="./style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <nav>
      <div class="userInfo">
        <span id="displayName"></span>
        <button onclick="doLogout()">Log out</button>
      </div>
      <div class="register">
        <p>Full name: <input id="reg_fullName" type="text" /></p>
        <p>Username: <input id="reg_username" type="text" /></p>
        <p>Password: <input id="reg_password" type="password" /></p>
        <p><button onclick="doRegister()">Register</button></p>
      </div>
      <div class="login">
        <p>Username: <input id="log_username" type="text" value="john" /></p>
        <p>Password: <input id="log_password" type="password" value="doe2023" /></p>
        <p><button onclick="doLogin()">Login</button></p>
      </div>
    </nav>
    <main>
      <aside></aside>
      <section></section>
    </main>
    <div class="modal" id="sendDocument" tabindex="-1" role="dialog" aria-labelledby="sendDocument" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Send Document</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="media-body">
              <div class="preview"></div>
              <textarea class="width-100" id="caption" data-emoji="true"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary">Send</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      var token, refreshToken, selectedChat, loggedUserName, userFullName, socket
      const BACKEND_URL = 'http://localhost:8080'
      const API = BACKEND_URL + '/api'

      const escapeHtml = unsafe =>
        unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;')

      async function doRegister() {
        const fullName = document.querySelector('#reg_fullName').value
        const username = document.querySelector('#reg_username').value
        const password = document.querySelector('#reg_password').value
        const data = await fetch(API + '/auth/register', {
          method: 'POST',
          body: JSON.stringify({fullName, username, password}),
          headers: {
            'Content-type': 'application/json',
          },
        })
        if (data.status === 201) {
          document.querySelector('.register').setAttribute('style', 'display: none;')
        } else {
          console.error(data)
          alert('Something went wrong!')
        }
      }

      async function doLogin() {
        const username = document.querySelector('#log_username').value
        const password = document.querySelector('#log_password').value
        const data = await fetch(API + '/auth/login', {
          method: 'POST',
          body: JSON.stringify({username, password}),
          headers: {
            'Content-type': 'application/json',
          },
        })
        if (data.ok) {
          document.querySelector('.register').setAttribute('style', 'display: none;')
          document.querySelector('.login').setAttribute('style', 'display: none;')
          const res = await data.json()
          document.querySelector('.userInfo').setAttribute('style', 'margin: auto 1em; display: block;')
          document.querySelector('#displayName').innerHTML = 'Hello, ' + res.data.fullName
          loggedUserName = res.data.username
          userFullName = res.data.fullName
          token = res.token
          refreshToken = res.refreshToken
          socket = io(BACKEND_URL, {
            auth: {token},
            path: '/api/chat',
          }).connect()
          socket.emit('getChats')
          socket.on('chats', updateChats)
          socket.on('allMessages', (allMessages, chattingUser) => {
            if (chattingUser.username === selectedChat) {
              updateUI(allMessages)
            } else {
              socket.emit('chats')
            }
          })
          socket.on('error', error => {
            alert(error.msg)
            console.error(error)
          })
          socket.on('newMessage', newMessage => {
            if (newMessage) {
              const lastMessage = document.querySelector(
                '#' + newMessage.sender.username === loggedUserName
                  ? loggedUserName
                  : newMessage.receiver.username + ' .lastMessage',
              )
              if (lastMessage)
                lastMessage.innerHTML =
                  (newMessage.sender.username === loggedUserName ? 'You: ' : newMessage.sender.username) +
                  newMessage.text
              document.querySelector('#message').value = ''
              const chatView = document.querySelector('#chat')
              chatView.innerHTML += `<div class="${
                newMessage.sender.username === selectedChat ? 'fromSender' : 'fromUser'
              }">${newMessage.text}
              ${newMessage.sender.username !== selectedChat && newMessage.read ? '<i>&#10003;</i>' : ''}
              </div>`
              chatView.scrollTop = chatView.scrollHeight
            } else {
              console.error(socket)
              alert('Something went wrong!')
            }
          })
          socket.on('typingEvent', typingUser => {
            document.querySelector(`#${typingUser} .lastMessage`).innerHTML = '...typing'
            document.querySelector(`#${typingUser} .lastMessage`).style.color = 'blue'
            setTimeout(() => socket.emit('getChats'), 2000)
          })
          socket.on('userOnline', onlineUser => {
            document.querySelector(`#${onlineUser} .status`).className = 'status online'
          })
          socket.on('userOffline', offlineUser => {
            document.querySelector(`#${offlineUser} .status`).className = 'status offline'
          })
        } else {
          console.error(await data.json())
          alert('Something went wrong!')
        }
      }

      function updateChats(chats) {
        const chatsView = document.querySelector('aside')
        chatsView.innerHTML = `<div class="newChat">
          <button onclick="((input) => {if (input) return getChat('New Chat', input); else return alert('User not found!') })(prompt('Enter username...'))">
            New Chat</button></div>`
        for (const chat of chats) {
          chatsView.innerHTML += `\n<div class="chat" id="${chat.username}" onclick="getChat('${chat.fullName}', '${
            chat.username
          }')">
          <span class="status ${chat.online ? 'online' : 'offline'}">‚óè</span>
          <span class="chatTitle">${chat.fullName}</span>
          ${chat.unreadCount ? '<span class="count">' + chat.unreadCount + '</span>' : ''}
          <span class="lastMessage">${chat.lastMessage.sender === loggedUserName ? 'You' : chat.username}: ${escapeHtml(
            chat.lastMessage.text,
          )}</span></div>`
        }
      }

      function doLogout() {
        token = null
        refreshToken = null
        selectedChat = null
        document.querySelector('.register').setAttribute('style', 'display: flex;')
        document.querySelector('.login').setAttribute('style', 'display: flex;')
        document.querySelector('.userInfo').setAttribute('style', 'display: none;')
        document.querySelector('aside').innerHTML = ''
        document.querySelector('section').innerHTML = ''
        document.querySelector('section').style.visibility = 'hidden'
        socket.disconnect()
      }

      async function updateUI(messages) {
        const chatView = document.querySelector('#chat')
        chatView.innerHTML = ''
        messages.forEach(message => {
          chatView.innerHTML += `<div class="${message.sender.username === selectedChat ? 'fromSender' : 'fromUser'}">${
            message.text
          }
          ${message.sender.username !== selectedChat && message.read ? '<i>&#10003;</i>' : ''}
        </div>`
        })
        chatView.scrollTop = chatView.scrollHeight
      }

      async function getChat(chatTitle, sender) {
        const chatView = document.querySelector('#chat')
        if (selectedChat === sender) {
          socket.emit('getChats')
          return true
        }
        document.querySelector('section').innerHTML = `<div class="topBar">
          <span id="topChatTitle"></span><span id="sender"></span>
        </div>
        <div id="chat"></div>
        <footer>
          <textarea id="message" onkeyup="typingEvent(event)"></textarea>
          <label for="files"><img src="./paperclip.png"></label><input id="files" type="file" hidden onchange="sendFile(this.files[0])">
          <button id="sendButton" onclick="sendMessage()">Send</button>
        </footer>`
        selectedChat = sender
        const countView = document.querySelector('#' + sender + ' .count')
        if (countView) countView.style.visibility = 'hidden'
        document.querySelector('section').style.visibility = 'visible'
        document.querySelector('#topChatTitle').innerHTML = chatTitle
        document.querySelector('#sender').innerHTML = 'Username: ' + sender
        socket.emit('getChat', selectedChat)
      }

      async function sendMessage() {
        const text = document.querySelector('#message').value
        if (!text) {
          return false
        }
        socket.emit('message', selectedChat, text)
        const chatView = document.querySelector('#chat')
        chatView.scrollTop = chatView.scrollHeight
      }

      function typingEvent(event) {
        if (event.which === 13 && !event.shiftKey) {
          event.preventDefault()
          sendMessage()
          return false
        } else {
          socket.emit('typing', loggedUserName, selectedChat)
        }
      }

      function sendFile(file) {
        var isImage
        if ((isImage = file.type.includes('image'))) {
          document.querySelector('.modal .preview').innerHTML = `<img class="mw-100 mh-100" src="${URL.createObjectURL(
            file,
          )}">`
        } else {
          document.querySelector('.modal .preview').innerHTML = `<a href="${URL.createObjectURL(file)}">${
            file.name
          }</a>`
        }
        $('#sendDocument').modal('show')
        const form = new FormData()
        form.append('document', file)
        document.querySelector('#sendDocument .btn-primary').addEventListener('click', async e => {
          e.preventDefault()
          const res = await (
            await fetch(API + '/upload', {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: form,
            })
          ).json()
          socket.emit(
            'document',
            selectedChat,
            isImage,
            res.data.filename,
            BACKEND_URL + res.data.document,
            document.querySelector('#caption').value,
          )
          $('#sendDocument').modal('hide')
        })
      }
    </script>
  </body>
</html>
